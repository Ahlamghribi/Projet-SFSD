#include <stdio.h>
#include <stdbool.h>
#include <string.h>

typedef struct {
    int jour, mois, annee;
} date;

typedef struct {
    char nom[20];
    int qte;
    float prix;
    int reference;
    char ingredient[30];
    struct date datefabr, dateexp;

} Medicament;

typedef struct {
    char tab[500];
    int nb;
} Bloc;

typedef struct {
    int nbrenrg, nbbloc;
} entete;
   

int main() {
    char choix;
    int reference;
    Medicament med;
    entete e;
    e.nbbloc = 1;
    e.nbrenrg = 0;
    FILE* fichier = fopen("medicaments.dat", "rb+");
    Bloc buf;
    buf.nb = 0;
    int j = 0;


    // Assuming a maximum of 1000 entries in the index
    Index index[1001];

    // Initialize index
    for (int i = 0; i < 1001; i++) {
        index[i].cas = 0;
        index[i].reference = 0;
        index[i].bloc = 0;
    }

    do {
        printf("\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n");
        printf("               Gestion des Medicaments\n");
        printf("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n");
        printf("Veuillez choisir une option :\n");
        printf("I - Inserer un medicament\n");
        printf("S - Supprimer un medicament\n");
        printf("R - Rechercher un medicament\n");
        printf("Q - Quitter\n");
        printf("Votre choix : ");
        scanf(" %c", &choix);

        switch (choix) {
            case 'I':
            case 'i':
                printf("\n==============================================\n");
                printf("             Ajout d'un Medicament\n");
                printf("==============================================\n");
                printf("Veuillez saisir les informations du medicament :\n");
                printf("La reference : ");
                scanf("%d", &med.reference);
                printf("Le nom : ");
                scanf("%s", med.nom);
                printf("La quantite de medicaments : ");
                scanf("%d", &med.qte);
                printf("Le prix de medicaments : ");
                scanf("%f", &med.prix);
                printf("La date de fabrication (jour mois annee) : ");
                scanf("%d %d %d", &med.datefabr.jour, &med.datefabr.mois, &med.datefabr.annee);
                printf("La date de l'expiration (jour mois annee) : ");
                scanf("%d %d %d", &med.dateexp.jour, &med.dateexp.mois, &med.dateexp.annee);

                buf = insertionAvecIndex(fichier, med, &e, &buf, index);
                buf.nb++;
                printf("==============================================\n");
                break;


case 'S':
case 's':
    printf("Donnez-moi la reference du medicament que vous voulez supprimer : ");
    scanf("%d", &reference);
    if (suppressionAvecIndex(reference, fichier, e, &buf, index)) {
        printf("Suppression reussie.\n");
                        printf("==============================================\n");

    } else {
        printf("La suppression a échoué. Le medicament n'a pas été trouvé.\n");
    }
    break;

            case 'R':
            case 'r':
                printf("\n==============================================\n");
                printf("            Recherche d'un Medicament\n");
                printf("==============================================\n");
                printf("Veuillez saisir la reference du medicament a rechercher : ");
                scanf("%d", &reference);
                location l = rechercheAvecIndex(reference, fichier, e, &buf, index);
                if (l.trouve) {
                    printf("\nLe medicament existe !!\n");

                } else {
                    printf("\nLe medicament n'existe pas.\n");
                }
                printf("==============================================\n");
                break;

            case 'Q':
            case 'q':
                break;

            default:
                printf("Choix invalide. Veuillez choisir parmi les options disponibles.\n");
        }

    } while (choix != 'Q' && choix != 'q');

    fclose(fichier);
    return 0;
}
