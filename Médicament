#include <stdio.h>
#include <stdbool.h>
#include <string.h>

typedef struct {
    int jour, mois, annee;
} date;

typedef struct {
    char nom[20];
    int qte;
    float prix;
    int reference;
    char ingredient[30];
    struct date datefabr, dateexp;

} Medicament;

typedef struct {
    char tab[500];
    int nb;
} Bloc;

typedef struct {
    int nbrenrg, nbbloc;
} entete;

int main() {
    char choix;
    int reference;
    Medicament med;
    entete e;
    e.nbbloc = 1;
    e.nbrenrg = 0;
    FILE* fichier = fopen("medicaments.dat", "rb+");
    Bloc buf;
    buf.nb = 0;
    int j = 0;

    // Supposant un maximum de 1000 entrées dans l'index
    Index index[1001];

    do {
        printf("\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n");
        printf("               Gestion des Médicaments\n");
        printf("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n");
        printf("Veuillez choisir une option :\n");
        printf("I - Insérer un médicament\n");
        printf("S - Supprimer un médicament\n");
        printf("R - Rechercher un médicament\n");
        printf("Q - Quitter\n");
        printf("Votre choix : ");
        scanf(" %c", &choix);

        switch (choix) {
            case 'I':
            case 'i':
                printf("\n==============================================\n");
                printf("             Ajout d'un Médicament\n");
                printf("==============================================\n");
                printf("Veuillez saisir les informations du médicament :\n");
                printf("La référence : ");
                scanf("%d", &med.reference);
                printf("Le nom : ");
                scanf("%s", med.nom);
                printf("La quantité de médicaments : ");
                scanf("%d", &med.qte);
                printf("Le prix de médicaments : ");
                scanf("%f", &med.prix);
                printf("La date de fabrication (jour mois année) : ");
                scanf("%d %d %d", &med.datefabr.jour, &med.datefabr.mois, &med.datefabr.annee);
                printf("La date de l'expiration (jour mois année) : ");
                scanf("%d %d %d", &med.dateexp.jour, &med.dateexp.mois, &med.dateexp.annee);

                // Insertion avec index
                buf = insertionAvecIndex(fichier, med, &e, &buf, index);
                buf.nb++;
                printf("==============================================\n");
                break;

            case 'S':
            case 's':
                printf("Donnez-moi la référence du médicament que vous voulez supprimer : ");
                scanf("%d", &reference);
                // Suppression avec index
                if (suppressionAvecIndex(reference, fichier, e, &buf, index)) {
                    printf("Suppression réussie.\n");
                    printf("==============================================\n");
                } else {
                    printf("La suppression a échoué. Le médicament n'a pas été trouvé.\n");
                }
                break;

            case 'R':
            case 'r':
                printf("\n==============================================\n");
                printf("            Recherche d'un Médicament\n");
                printf("==============================================\n");
                printf("Veuillez saisir la référence du médicament à rechercher : ");
                scanf("%d", &reference);
                // Recherche avec index
                location l = rechercheAvecIndex(reference, fichier, e, &buf, index);
                if (l.trouve) {
                    printf("\nLe médicament existe !!\n");
                } else {
                    printf("\nLe médicament n'existe pas.\n");
                }
                printf("==============================================\n");
                break;

            case 'Q':
            case 'q':
                break;

            default:
                printf("Choix invalide. Veuillez choisir parmi les options disponibles.\n");
        }

    } while (choix != 'Q' && choix != 'q');

    // Fermeture du fichier
    fclose(fichier);

    return 0;
}
